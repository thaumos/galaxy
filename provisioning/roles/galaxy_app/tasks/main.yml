---

- name: Create the /etc/galaxy directory
  file: path=/etc/galaxy owner=root group=galaxy_manage mode=2770 state=directory

- name: Install development tools
  npm: path={{ galaxy_project_dir }}

- name: Install gulp globally
  npm: name=gulp global=yes

- name: Install less globally
  npm: name=less global=yes

- name: Intall galaxy
  command: python ./setup.py develop
  args:
    chdir: /galaxy_devel

- name: Deploy settings file
  template: src=settings.py.j2 dest=/etc/galaxy/settings.py owner=root group=galaxy_manage mode=0660

- name: Create the SECRET_KEY file
  command: /usr/bin/python -c "import uuid; file('/etc/galaxy/SECRET_KEY', 'wb').write(uuid.uuid4().hex)" creates=/etc/galaxy/SECRET_KEY

- name: Adjust SECRET_KEY permissions
  file: path=/etc/galaxy/SECRET_KEY state=file owner=root group=galaxy_manage mode=0660

- name: Start memcached and make sure it is enabled at boot
  service: name=memcached state=running enabled=true

- name: Migrate sites
  command: galaxy-manage migrate sites --noinput
  ignore_errors: yes

- name: Migrate account
  command: galaxy-manage migrate account --noinput
  ignore_errors: yes

- name: Migrate the full application
  command: galaxy-manage migrate --noinput
